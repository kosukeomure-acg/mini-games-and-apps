# テトリス設計書

## 1. 概要

### 1.1 プロジェクト概要
ブラウザで動作するクラシックテトリスゲームの実装。HTML5 Canvas APIを使用し、単一のHTMLファイルで完結する構成。

### 1.2 技術スタック
- **言語**: HTML5, CSS3, JavaScript (ES6+)
- **描画**: Canvas API
- **アニメーション**: requestAnimationFrame

---

## 2. ゲーム仕様

### 2.1 基本ルール
- 10列 × 20行のプレイフィールド
- 7種類のテトリミノが順次落下
- 横一列が埋まるとライン消去
- ブロックが最上部に到達するとゲームオーバー

### 2.2 スコアリングシステム

| 消去ライン数 | 基本点数 |
|------------|---------|
| 1ライン    | 100点   |
| 2ライン    | 300点   |
| 3ライン    | 500点   |
| 4ライン    | 800点   |

- 最終スコア = 基本点数 × 現在レベル
- ソフトドロップ: 1マスにつき1点
- ハードドロップ: 1マスにつき2点

### 2.3 レベルシステム
- 10ライン消去ごとにレベルアップ
- レベルが上がるごとに落下速度が上昇
- 落下間隔: `max(100ms, 1000ms - (level - 1) × 100ms)`

---

## 3. アーキテクチャ設計

### 3.1 システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                      HTML/CSS                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │  メイン     │  │  サイド     │  │ ゲームオーバー│      │
│  │  ボード     │  │  パネル     │  │  オーバーレイ │      │
│  └─────────────┘  └─────────────┘  └─────────────┘      │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   JavaScript Engine                      │
│  ┌─────────────────────────────────────────────────┐    │
│  │                  Game Loop                       │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐         │    │
│  │  │ Update  │→│ Render  │→│  RAF    │─┐        │    │
│  │  └─────────┘  └─────────┘  └─────────┘ │        │    │
│  │       ↑                                 │        │    │
│  │       └─────────────────────────────────┘        │    │
│  └─────────────────────────────────────────────────┘    │
│                          │                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │  State   │  │  Input   │  │ Renderer │              │
│  │ Manager  │  │ Handler  │  │          │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
```

### 3.2 データ構造

#### 3.2.1 ゲームボード
```javascript
// 20行 × 10列の2次元配列
// 0 = 空, 1-7 = テトリミノの種類
board = [
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  // 行0 (最上部)
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  ...
  [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]   // 行19 (最下部)
]
```

#### 3.2.2 テトリミノオブジェクト
```javascript
piece = {
  shape: [[...], [...], [...]],  // 形状を表す2次元配列
  type: 1-7,                      // テトリミノの種類
  x: 0,                           // X座標（左端からのオフセット）
  y: 0                            // Y座標（上端からのオフセット）
}
```

#### 3.2.3 テトリミノ定義

| タイプ | 名称 | 色        | 形状 |
|-------|-----|-----------|------|
| 1     | I   | シアン    | ████ |
| 2     | J   | 青        | █<br>███ |
| 3     | L   | オレンジ  | &nbsp;&nbsp;█<br>███ |
| 4     | O   | 黄        | ██<br>██ |
| 5     | S   | 緑        | &nbsp;██<br>██ |
| 6     | T   | 紫        | &nbsp;█<br>███ |
| 7     | Z   | 赤        | ██<br>&nbsp;██ |

---

## 4. モジュール設計

### 4.1 定数定義

```javascript
const COLS = 10;           // 列数
const ROWS = 20;           // 行数
const BLOCK_SIZE = 30;     // ブロックサイズ（ピクセル）
const NEXT_BLOCK_SIZE = 25; // 次ブロック表示サイズ
```

### 4.2 主要関数

| 関数名 | 説明 | 引数 | 戻り値 |
|-------|------|------|-------|
| `createBoard()` | 空のゲームボードを生成 | なし | 2次元配列 |
| `createPiece(type)` | 指定タイプのピースを生成 | type: 1-7 | ピースオブジェクト |
| `randomPiece()` | ランダムなピースを生成 | なし | ピースオブジェクト |
| `collision(piece, board, offsetX, offsetY)` | 衝突判定 | ピース, ボード, オフセット | boolean |
| `rotate(piece)` | ピースを90度回転 | ピース | 回転後の形状配列 |
| `rotatePiece()` | 壁キック付き回転処理 | なし | void |
| `mergePiece()` | ピースをボードに固定 | なし | void |
| `clearLines()` | 完成ラインを消去 | なし | void |
| `dropPiece()` | ピースを1マス落下 | なし | void |
| `hardDrop()` | ピースを即座に落下 | なし | void |

### 4.3 描画関数

| 関数名 | 説明 |
|-------|------|
| `drawBlock(ctx, x, y, color, size)` | 単一ブロックを描画（ハイライト・シャドウ付き）|
| `drawBoard()` | ゲームボード全体を描画 |
| `drawPiece()` | 現在のピースとゴーストを描画 |
| `drawNext()` | 次のピースプレビューを描画 |
| `draw()` | メイン描画処理 |

### 4.4 ゲーム制御関数

| 関数名 | 説明 |
|-------|------|
| `init()` | ゲーム初期化 |
| `gameLoop(time)` | メインゲームループ |
| `restartGame()` | ゲームリスタート |
| `updateDisplay()` | UI表示更新 |
| `showGameOver()` | ゲームオーバー表示 |

---

## 5. 状態管理

### 5.1 ゲーム状態変数

```javascript
let board = [];           // ゲームボード
let score = 0;            // 現在のスコア
let level = 1;            // 現在のレベル
let lines = 0;            // 消去ライン数
let gameOver = false;     // ゲームオーバーフラグ
let paused = false;       // 一時停止フラグ
let currentPiece = null;  // 現在操作中のピース
let nextPiece = null;     // 次のピース
let dropCounter = 0;      // 落下タイマー
let lastTime = 0;         // 前フレームの時間
```

### 5.2 状態遷移図

```
        ┌─────────────┐
        │   初期化    │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
   ┌───▶│  プレイ中   │◀───┐
   │    └──────┬──────┘    │
   │           │           │
   │    ┌──────┴──────┐    │
   │    ▼             ▼    │
┌──┴────────┐   ┌──────────┴──┐
│ 一時停止  │   │ ゲームオーバー│
└───────────┘   └──────┬──────┘
                       │
                       ▼
                ┌─────────────┐
                │  リスタート  │
                └─────────────┘
```

---

## 6. 入力処理

### 6.1 キーマッピング

| キー | アクション |
|-----|-----------|
| ← (ArrowLeft) | 左移動 |
| → (ArrowRight) | 右移動 |
| ↑ (ArrowUp) | 回転 |
| ↓ (ArrowDown) | ソフトドロップ（高速落下）|
| Space | ハードドロップ（即落下）|
| P | 一時停止/再開 |

### 6.2 入力処理フロー

```
キー入力
    │
    ▼
┌───────────────┐
│ゲームオーバー？│──Yes──▶ 無視
└───────┬───────┘
        │No
        ▼
┌───────────────┐
│ Pキー？       │──Yes──▶ 一時停止切替
└───────┬───────┘
        │No
        ▼
┌───────────────┐
│ 一時停止中？  │──Yes──▶ 無視
└───────┬───────┘
        │No
        ▼
    移動/回転処理
```

---

## 7. 描画システム

### 7.1 レイヤー構成

1. **背景レイヤー**: グリッド線
2. **ボードレイヤー**: 固定されたブロック
3. **ゴーストレイヤー**: 落下予測位置
4. **ピースレイヤー**: 現在操作中のピース

### 7.2 ブロック描画仕様

```
┌─────────────────────────────────┐
│███████████████████████ ハイライト│
│███                         ███ │
│███                         ███ │
│███       メインカラー       ███ │
│███                         ███ │
│███                         ███ │
│███████████████████████ シャドウ │
└─────────────────────────────────┘
```

---

## 8. UI/UXデザイン

### 8.1 画面レイアウト

```
┌────────────────────────────────────────────┐
│                                            │
│   ┌──────────────┐  ┌─────────────┐       │
│   │              │  │   スコア     │       │
│   │              │  │    0        │       │
│   │              │  ├─────────────┤       │
│   │              │  │   レベル     │       │
│   │  ゲーム      │  │    1        │       │
│   │  ボード      │  ├─────────────┤       │
│   │  (10×20)    │  │   ライン     │       │
│   │              │  │    0        │       │
│   │              │  ├─────────────┤       │
│   │              │  │ 次のブロック │       │
│   │              │  │   [    ]    │       │
│   │              │  ├─────────────┤       │
│   │              │  │  操作方法   │       │
│   │              │  │  ←→ 移動   │       │
│   │              │  │  ↑  回転   │       │
│   └──────────────┘  └─────────────┘       │
│                                            │
└────────────────────────────────────────────┘
```

### 8.2 カラーパレット

| 要素 | カラーコード | 用途 |
|-----|-------------|------|
| 背景（グラデーション開始）| #1a1a2e | body背景 |
| 背景（グラデーション終了）| #16213e | body背景 |
| ボード背景 | #0f0f23 | ゲームエリア |
| キャンバス背景 | #0a0a1a | プレイフィールド |
| ボーダー | #4a4a8a | パネル枠線 |
| テキスト（通常）| #888 | 説明文 |
| テキスト（ヘッダー）| #8888cc | セクションタイトル |
| アクセント | #00ff88 | スコア値、ハイライト |
| 警告 | #ff4444 | ゲームオーバー |

---

## 9. アルゴリズム詳細

### 9.1 衝突判定アルゴリズム

```
collision(piece, board, offsetX, offsetY):
    FOR each cell in piece.shape:
        IF cell is not empty:
            newX = piece.x + cellX + offsetX
            newY = piece.y + cellY + offsetY

            // 境界チェック
            IF newX < 0 OR newX >= COLS OR newY >= ROWS:
                RETURN true (collision)

            // ボードとの衝突チェック
            IF newY >= 0 AND board[newY][newX] != 0:
                RETURN true (collision)

    RETURN false (no collision)
```

### 9.2 回転アルゴリズム（90度時計回り）

```
rotate(piece):
    // 行と列を入れ替えて、各行を反転
    rotated = transpose(piece.shape).reverseEachRow()
    RETURN rotated
```

### 9.3 壁キックアルゴリズム

```
rotatePiece():
    rotated = rotate(currentPiece)
    originalShape = currentPiece.shape
    currentPiece.shape = rotated

    offset = 1
    WHILE collision detected:
        currentPiece.x += offset
        offset = -(offset + sign(offset))

        IF |offset| > piece width:
            // 回転不可、元に戻す
            currentPiece.shape = originalShape
            RETURN
```

### 9.4 ライン消去アルゴリズム

```
clearLines():
    linesCleared = 0

    FOR y = ROWS-1 TO 0:
        IF row[y] is completely filled:
            remove row[y]
            insert empty row at top
            linesCleared++
            y++  // 同じ行を再チェック

    IF linesCleared > 0:
        update score
        update level
```

---

## 10. 拡張性考慮

### 10.1 将来の拡張案

1. **ホールド機能**: 現在のピースを保持して後で使用
2. **複数ネクスト表示**: 次の2-3ピースをプレビュー
3. **Tスピン判定**: 特殊回転ボーナス
4. **コンボシステム**: 連続ライン消去ボーナス
5. **サウンドエフェクト**: Web Audio APIを使用
6. **タッチ操作対応**: モバイルデバイス対応
7. **ハイスコア保存**: LocalStorage使用
8. **オンラインランキング**: サーバー連携

### 10.2 リファクタリング案

現在のコードは単一ファイル構成だが、以下のようにモジュール分割が可能:

```
tetris/
├── index.html
├── css/
│   └── style.css
└── js/
    ├── main.js          # エントリーポイント
    ├── game.js          # ゲームロジック
    ├── piece.js         # テトリミノ管理
    ├── board.js         # ボード管理
    ├── renderer.js      # 描画処理
    ├── input.js         # 入力処理
    └── constants.js     # 定数定義
```

---

## 11. テスト仕様

### 11.1 単体テスト項目

| テスト対象 | テスト内容 |
|-----------|-----------|
| createBoard() | 20×10の空配列が生成されること |
| createPiece() | 各タイプで正しい形状が生成されること |
| collision() | 境界・ブロック衝突が正しく判定されること |
| rotate() | 90度回転が正しく行われること |
| clearLines() | 完成ラインが消去されスコアが加算されること |

### 11.2 結合テスト項目

| テスト内容 |
|-----------|
| ゲーム開始から終了までの一連の流れ |
| キー入力による移動・回転の応答 |
| レベルアップによる速度変化 |
| 一時停止・再開の動作 |
| ゲームオーバー後のリスタート |

---

## 12. 改訂履歴

| 日付 | バージョン | 内容 |
|-----|-----------|------|
| 2025-12-18 | 1.0 | 初版作成 |
