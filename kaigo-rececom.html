<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»‹è­·ä¿é™ºãƒ¬ã‚»ãƒ—ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Meiryo', 'Hiragino Kaku Gothic Pro', sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%);
            color: #fff;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 24px;
            font-weight: normal;
        }

        .header-info {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 220px;
            background: #2c3e50;
            padding: 20px 0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 15px 25px;
            color: #ecf0f1;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.3s;
            font-size: 14px;
        }

        .sidebar-menu li:hover {
            background: #34495e;
        }

        .sidebar-menu li.active {
            background: #34495e;
            border-left-color: #3498db;
        }

        .sidebar-menu li i {
            margin-right: 10px;
            width: 20px;
        }

        .main-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-title {
            font-size: 22px;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .form-group.small {
            min-width: 120px;
        }

        .form-group.large {
            min-width: 300px;
            flex: 1;
        }

        .form-group label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .btn-primary {
            background: #3498db;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: #fff;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        table th,
        table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: bold;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .badge-green {
            background: #d4edda;
            color: #155724;
        }

        .badge-yellow {
            background: #fff3cd;
            color: #856404;
        }

        .badge-blue {
            background: #cce5ff;
            color: #004085;
        }

        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            flex: 1;
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .stat-card .label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-card .unit {
            font-size: 14px;
            color: #666;
            margin-left: 5px;
        }

        .stat-card.blue {
            border-left: 4px solid #3498db;
        }

        .stat-card.green {
            border-left: 4px solid #27ae60;
        }

        .stat-card.orange {
            border-left: 4px solid #e67e22;
        }

        .stat-card.purple {
            border-left: 4px solid #9b59b6;
        }

        .service-table {
            margin-top: 15px;
        }

        .service-table input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .total-row {
            background: #e8f4fc !important;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .print-area {
            background: #fff;
            padding: 30px;
            border: 1px solid #ddd;
        }

        .print-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .print-header h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .print-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .print-table th,
        .print-table td {
            border: 1px solid #333;
            padding: 8px;
        }

        .print-table th {
            background: #f0f0f0;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 10px;
        }

        .calendar-header {
            background: #3498db;
            color: #fff;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }

        .calendar-day {
            background: #fff;
            border: 1px solid #eee;
            padding: 5px;
            min-height: 60px;
            font-size: 11px;
        }

        .calendar-day .date {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .calendar-day .service {
            background: #3498db;
            color: #fff;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 10px;
            margin-top: 2px;
        }

        .calendar-day.sunday .date {
            color: #e74c3c;
        }

        .calendar-day.saturday .date {
            color: #3498db;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ä»‹è­·ä¿é™ºãƒ¬ã‚»ãƒ—ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿</h1>
        <div class="header-info">
            <span>äº‹æ¥­æ‰€ç•ªå·: 1234567890</span>
            <span>ã‚µãƒ³ãƒ—ãƒ«ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹äº‹æ¥­æ‰€</span>
            <span id="currentDate"></span>
        </div>
    </div>

    <div class="container">
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li class="active" onclick="showPage('dashboard')">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
                <li onclick="showPage('users')">ğŸ‘¥ åˆ©ç”¨è€…ç®¡ç†</li>
                <li onclick="showPage('service-input')">ğŸ“ ã‚µãƒ¼ãƒ“ã‚¹å®Ÿç¸¾å…¥åŠ›</li>
                <li onclick="showPage('care-plan')">ğŸ“‹ ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ç®¡ç†</li>
                <li onclick="showPage('billing')">ğŸ’´ è«‹æ±‚å‡¦ç†</li>
                <li onclick="showPage('reports')">ğŸ“„ å¸³ç¥¨å‡ºåŠ›</li>
                <li onclick="showPage('master')">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div id="dashboard" class="page active">
                <h2 class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>

                <div class="stats-row">
                    <div class="stat-card blue">
                        <div class="label">ç™»éŒ²åˆ©ç”¨è€…æ•°</div>
                        <div class="value" id="totalUsers">0<span class="unit">å</span></div>
                    </div>
                    <div class="stat-card green">
                        <div class="label">ä»Šæœˆã®ã‚µãƒ¼ãƒ“ã‚¹æä¾›å›æ•°</div>
                        <div class="value" id="totalServices">0<span class="unit">å›</span></div>
                    </div>
                    <div class="stat-card orange">
                        <div class="label">ä»Šæœˆã®è«‹æ±‚äºˆå®šé¡</div>
                        <div class="value" id="totalBilling">0<span class="unit">å††</span></div>
                    </div>
                    <div class="stat-card purple">
                        <div class="label">æœªè«‹æ±‚ä»¶æ•°</div>
                        <div class="value" id="unbilledCount">0<span class="unit">ä»¶</span></div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">ä»Šæœˆã®ã‚µãƒ¼ãƒ“ã‚¹æä¾›çŠ¶æ³</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>åˆ©ç”¨è€…å</th>
                                <th>è¦ä»‹è­·åº¦</th>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡</th>
                                <th>æä¾›å›æ•°</th>
                                <th>å˜ä½æ•°</th>
                                <th>è«‹æ±‚çŠ¶æ³</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTable">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- åˆ©ç”¨è€…ç®¡ç† -->
            <div id="users" class="page">
                <h2 class="page-title">åˆ©ç”¨è€…ç®¡ç†</h2>

                <div class="card">
                    <div class="search-box">
                        <input type="text" id="userSearch" placeholder="åˆ©ç”¨è€…åãƒ»è¢«ä¿é™ºè€…ç•ªå·ã§æ¤œç´¢...">
                        <button class="btn btn-primary" onclick="searchUsers()">æ¤œç´¢</button>
                        <button class="btn btn-success" onclick="showUserModal()">+ æ–°è¦ç™»éŒ²</button>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>è¢«ä¿é™ºè€…ç•ªå·</th>
                                <th>åˆ©ç”¨è€…å</th>
                                <th>ç”Ÿå¹´æœˆæ—¥</th>
                                <th>è¦ä»‹è­·åº¦</th>
                                <th>èªå®šæœ‰åŠ¹æœŸé–“</th>
                                <th>æ”¯çµ¦é™åº¦é¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userTable">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ã‚µãƒ¼ãƒ“ã‚¹å®Ÿç¸¾å…¥åŠ› -->
            <div id="service-input" class="page">
                <h2 class="page-title">ã‚µãƒ¼ãƒ“ã‚¹å®Ÿç¸¾å…¥åŠ›</h2>

                <div class="card">
                    <h3 class="card-title">åˆ©ç”¨è€…é¸æŠ</h3>
                    <div class="form-row">
                        <div class="form-group large">
                            <label>åˆ©ç”¨è€…</label>
                            <select id="serviceUser" onchange="loadUserServices()">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ã‚µãƒ¼ãƒ“ã‚¹æä¾›å¹´æœˆ</label>
                            <input type="month" id="serviceMonth" onchange="loadUserServices()">
                        </div>
                    </div>
                </div>

                <div class="card" id="serviceInputArea" style="display: none;">
                    <h3 class="card-title">ã‚µãƒ¼ãƒ“ã‚¹å®Ÿç¸¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
                    <div id="userServiceInfo"></div>
                    <div class="calendar" id="serviceCalendar"></div>

                    <h3 class="card-title" style="margin-top: 25px;">ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹å…¥åŠ›</h3>
                    <table class="service-table">
                        <thead>
                            <tr>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰</th>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹</th>
                                <th>å˜ä½æ•°</th>
                                <th>å›æ•°</th>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹å˜ä½æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="serviceInputTable">
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: right;">åˆè¨ˆå˜ä½æ•°</td>
                                <td id="totalUnits">0</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: right;">æ”¯çµ¦é™åº¦é¡å†…å˜ä½æ•°</td>
                                <td id="limitUnits">0</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: right;">é™åº¦é¡è¶…éå˜ä½æ•°</td>
                                <td id="overUnits">0</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveServices()">ä¿å­˜</button>
                        <button class="btn btn-secondary" onclick="clearServices()">ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>
            </div>

            <!-- ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ç®¡ç† -->
            <div id="care-plan" class="page">
                <h2 class="page-title">ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ç®¡ç†</h2>

                <div class="card">
                    <div class="form-row">
                        <div class="form-group large">
                            <label>åˆ©ç”¨è€…</label>
                            <select id="carePlanUser" onchange="loadCarePlan()">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card" id="carePlanArea" style="display: none;">
                    <h3 class="card-title">å±…å®…ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»æ›¸</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä½œæˆæ—¥</label>
                            <input type="date" id="planDate">
                        </div>
                        <div class="form-group">
                            <label>è¨ˆç”»æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
                            <input type="date" id="planStart">
                        </div>
                        <div class="form-group">
                            <label>è¨ˆç”»æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
                            <input type="date" id="planEnd">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group large">
                            <label>åˆ©ç”¨è€…åŠã³å®¶æ—ã®ç”Ÿæ´»ã«å¯¾ã™ã‚‹æ„å‘</label>
                            <textarea rows="3" id="planWish"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group large">
                            <label>ç·åˆçš„ãªæ´åŠ©ã®æ–¹é‡</label>
                            <textarea rows="3" id="planPolicy"></textarea>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 10px;">é€±é–“ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡</th>
                                <th>æœˆ</th>
                                <th>ç«</th>
                                <th>æ°´</th>
                                <th>æœ¨</th>
                                <th>é‡‘</th>
                                <th>åœŸ</th>
                                <th>æ—¥</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyPlanTable">
                        </tbody>
                    </table>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveCarePlan()">ä¿å­˜</button>
                        <button class="btn btn-success" onclick="printCarePlan()">å°åˆ·</button>
                    </div>
                </div>
            </div>

            <!-- è«‹æ±‚å‡¦ç† -->
            <div id="billing" class="page">
                <h2 class="page-title">è«‹æ±‚å‡¦ç†</h2>

                <div class="card">
                    <h3 class="card-title">è«‹æ±‚ãƒ‡ãƒ¼ã‚¿ä½œæˆ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è«‹æ±‚å¹´æœˆ</label>
                            <input type="month" id="billingMonth">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" style="margin-top: 22px;" onclick="generateBillingData()">è«‹æ±‚ãƒ‡ãƒ¼ã‚¿ä½œæˆ</button>
                        </div>
                    </div>
                </div>

                <div class="card" id="billingResult" style="display: none;">
                    <h3 class="card-title">è«‹æ±‚ä¸€è¦§</h3>
                    <div class="alert alert-info">
                        è«‹æ±‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°ã€Œè«‹æ±‚ç¢ºå®šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>è¢«ä¿é™ºè€…ç•ªå·</th>
                                <th>åˆ©ç”¨è€…å</th>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡</th>
                                <th>å˜ä½æ•°</th>
                                <th>ä¿é™ºè«‹æ±‚é¡</th>
                                <th>åˆ©ç”¨è€…è² æ‹…é¡</th>
                                <th>çŠ¶æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="billingTable">
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4" style="text-align: right;">åˆè¨ˆ</td>
                                <td id="totalInsurance">0å††</td>
                                <td id="totalUserCharge">0å††</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="confirmBilling()">è«‹æ±‚ç¢ºå®š</button>
                        <button class="btn btn-primary" onclick="exportCSV()">CSVå‡ºåŠ›</button>
                    </div>
                </div>
            </div>

            <!-- å¸³ç¥¨å‡ºåŠ› -->
            <div id="reports" class="page">
                <h2 class="page-title">å¸³ç¥¨å‡ºåŠ›</h2>

                <div class="card">
                    <h3 class="card-title">å¸³ç¥¨é¸æŠ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¸³ç¥¨ç¨®é¡</label>
                            <select id="reportType">
                                <option value="meisai">ä»‹è­·çµ¦ä»˜è²»æ˜ç´°æ›¸</option>
                                <option value="seikyu">ä»‹è­·çµ¦ä»˜è²»è«‹æ±‚æ›¸</option>
                                <option value="riyohyo">ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ç¥¨</option>
                                <option value="jisseki">ã‚µãƒ¼ãƒ“ã‚¹æä¾›ç¥¨</option>
                                <option value="ryoshu">é ˜åæ›¸</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¯¾è±¡å¹´æœˆ</label>
                            <input type="month" id="reportMonth">
                        </div>
                        <div class="form-group large">
                            <label>åˆ©ç”¨è€…</label>
                            <select id="reportUser">
                                <option value="all">å…¨å“¡</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="previewReport()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                        <button class="btn btn-success" onclick="printReport()">å°åˆ·</button>
                    </div>
                </div>

                <div class="card" id="reportPreview" style="display: none;">
                    <h3 class="card-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div class="print-area" id="printArea">
                        <!-- å¸³ç¥¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é ˜åŸŸ -->
                    </div>
                </div>
            </div>

            <!-- ãƒã‚¹ã‚¿ç®¡ç† -->
            <div id="master" class="page">
                <h2 class="page-title">ãƒã‚¹ã‚¿ç®¡ç†</h2>

                <div class="card">
                    <h3 class="card-title">äº‹æ¥­æ‰€æƒ…å ±</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>äº‹æ¥­æ‰€ç•ªå·</label>
                            <input type="text" id="jigyoshoNo" value="1234567890">
                        </div>
                        <div class="form-group large">
                            <label>äº‹æ¥­æ‰€å</label>
                            <input type="text" id="jigyoshoName" value="ã‚µãƒ³ãƒ—ãƒ«ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹äº‹æ¥­æ‰€">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group large">
                            <label>æ‰€åœ¨åœ°</label>
                            <input type="text" id="jigyoshoAddress" value="æ±äº¬éƒ½åƒä»£ç”°åŒºâ—‹â—‹1-2-3">
                        </div>
                        <div class="form-group">
                            <label>é›»è©±ç•ªå·</label>
                            <input type="text" id="jigyoshoTel" value="03-1234-5678">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡</label>
                            <select id="serviceType">
                                <option value="11">è¨ªå•ä»‹è­·</option>
                                <option value="12">è¨ªå•å…¥æµ´ä»‹è­·</option>
                                <option value="13">è¨ªå•çœ‹è­·</option>
                                <option value="15">é€šæ‰€ä»‹è­·</option>
                                <option value="17">é€šæ‰€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>åœ°åŸŸåŒºåˆ†</label>
                            <select id="areaClass">
                                <option value="1">1ç´šåœ°ï¼ˆæ±äº¬23åŒºï¼‰</option>
                                <option value="2">2ç´šåœ°</option>
                                <option value="3">3ç´šåœ°</option>
                                <option value="4">4ç´šåœ°</option>
                                <option value="5">5ç´šåœ°</option>
                                <option value="6">6ç´šåœ°</option>
                                <option value="7">7ç´šåœ°</option>
                                <option value="other">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveMaster()">ä¿å­˜</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰</th>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ç•¥ç§°</th>
                                <th>å˜ä½æ•°</th>
                                <th>ç®—å®šå˜ä½</th>
                            </tr>
                        </thead>
                        <tbody id="serviceCodeTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- åˆ©ç”¨è€…ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ©ç”¨è€…ç™»éŒ²</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>è¢«ä¿é™ºè€…ç•ªå· *</label>
                        <input type="text" id="modalHihokenNo" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label>åˆ©ç”¨è€…å *</label>
                        <input type="text" id="modalUserName">
                    </div>
                    <div class="form-group">
                        <label>ãƒ•ãƒªã‚¬ãƒŠ *</label>
                        <input type="text" id="modalUserKana">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”Ÿå¹´æœˆæ—¥ *</label>
                        <input type="date" id="modalBirthDate">
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <select id="modalGender">
                            <option value="1">ç”·æ€§</option>
                            <option value="2">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è¦ä»‹è­·åº¦ *</label>
                        <select id="modalCareLevel">
                            <option value="12">è¦æ”¯æ´1</option>
                            <option value="13">è¦æ”¯æ´2</option>
                            <option value="21">è¦ä»‹è­·1</option>
                            <option value="22">è¦ä»‹è­·2</option>
                            <option value="23">è¦ä»‹è­·3</option>
                            <option value="24">è¦ä»‹è­·4</option>
                            <option value="25">è¦ä»‹è­·5</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>èªå®šæœ‰åŠ¹æœŸé–“ï¼ˆé–‹å§‹ï¼‰*</label>
                        <input type="date" id="modalCertStart">
                    </div>
                    <div class="form-group">
                        <label>èªå®šæœ‰åŠ¹æœŸé–“ï¼ˆçµ‚äº†ï¼‰*</label>
                        <input type="date" id="modalCertEnd">
                    </div>
                    <div class="form-group">
                        <label>è² æ‹…å‰²åˆ</label>
                        <select id="modalBurdenRatio">
                            <option value="1">1å‰²</option>
                            <option value="2">2å‰²</option>
                            <option value="3">3å‰²</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group large">
                        <label>ä½æ‰€</label>
                        <input type="text" id="modalAddress">
                    </div>
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="text" id="modalTel">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group large">
                        <label>ä¿é™ºè€…ç•ªå·</label>
                        <input type="text" id="modalHokenshaNo" maxlength="6">
                    </div>
                    <div class="form-group large">
                        <label>ä¿é™ºè€…å</label>
                        <input type="text" id="modalHokenshaName">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveUser()">ç™»éŒ²</button>
                    <button class="btn btn-secondary" onclick="closeUserModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ï¼ˆå®Ÿéš›ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰DBï¼‰
        let users = [];
        let services = [];
        let billingData = [];

        // è¦ä»‹è­·åº¦ãƒã‚¹ã‚¿
        const careLevelMaster = {
            '12': { name: 'è¦æ”¯æ´1', limit: 5032 },
            '13': { name: 'è¦æ”¯æ´2', limit: 10531 },
            '21': { name: 'è¦ä»‹è­·1', limit: 16765 },
            '22': { name: 'è¦ä»‹è­·2', limit: 19705 },
            '23': { name: 'è¦ä»‹è­·3', limit: 27048 },
            '24': { name: 'è¦ä»‹è­·4', limit: 30938 },
            '25': { name: 'è¦ä»‹è­·5', limit: 36217 }
        };

        // ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ï¼ˆè¨ªå•ä»‹è­·ã®ä¾‹ï¼‰
        const serviceCodeMaster = [
            { code: '111111', name: 'èº«ä½“ä»‹è­·1', units: 163, unit_type: 'å›' },
            { code: '111112', name: 'èº«ä½“ä»‹è­·2', units: 308, unit_type: 'å›' },
            { code: '111113', name: 'èº«ä½“ä»‹è­·3', units: 453, unit_type: 'å›' },
            { code: '112111', name: 'ç”Ÿæ´»æ´åŠ©1', units: 183, unit_type: 'å›' },
            { code: '112112', name: 'ç”Ÿæ´»æ´åŠ©2', units: 225, unit_type: 'å›' },
            { code: '113111', name: 'èº«ä½“ç”Ÿæ´»1', units: 246, unit_type: 'å›' },
            { code: '113112', name: 'èº«ä½“ç”Ÿæ´»2', units: 391, unit_type: 'å›' },
            { code: '114111', name: 'é€šé™¢ç­‰ä¹—é™ä»‹åŠ©', units: 99, unit_type: 'å›' }
        ];

        // å˜ä½å˜ä¾¡ï¼ˆåœ°åŸŸåŒºåˆ†1ç´šåœ°ã®å ´åˆï¼‰
        const unitPrice = 11.40;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeData();
            updateDashboard();
            renderServiceCodeTable();
            setCurrentDate();
            setDefaultMonth();
        });

        function setCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent =
                `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
        }

        function setDefaultMonth() {
            const now = new Date();
            const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('serviceMonth').value = month;
            document.getElementById('billingMonth').value = month;
            document.getElementById('reportMonth').value = month;
        }

        function initializeData() {
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            users = [
                {
                    id: 1,
                    hihokenNo: 'H0000000001',
                    name: 'å±±ç”° å¤ªéƒ',
                    kana: 'ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦',
                    birthDate: '1940-05-15',
                    gender: '1',
                    careLevel: '22',
                    certStart: '2024-04-01',
                    certEnd: '2025-03-31',
                    burdenRatio: '1',
                    address: 'æ±äº¬éƒ½æ–°å®¿åŒºâ—‹â—‹1-1-1',
                    tel: '03-1111-2222',
                    hokenshaNo: '131001',
                    hokenshaName: 'æ–°å®¿åŒº'
                },
                {
                    id: 2,
                    hihokenNo: 'H0000000002',
                    name: 'ä½è—¤ èŠ±å­',
                    kana: 'ã‚µãƒˆã‚¦ ãƒãƒŠã‚³',
                    birthDate: '1935-08-20',
                    gender: '2',
                    careLevel: '23',
                    certStart: '2024-06-01',
                    certEnd: '2025-05-31',
                    burdenRatio: '1',
                    address: 'æ±äº¬éƒ½æ¸‹è°·åŒºâ—‹â—‹2-2-2',
                    tel: '03-3333-4444',
                    hokenshaNo: '131024',
                    hokenshaName: 'æ¸‹è°·åŒº'
                },
                {
                    id: 3,
                    hihokenNo: 'H0000000003',
                    name: 'éˆ´æœ¨ ä¸€éƒ',
                    kana: 'ã‚¹ã‚ºã‚­ ã‚¤ãƒãƒ­ã‚¦',
                    birthDate: '1942-12-10',
                    gender: '1',
                    careLevel: '21',
                    certStart: '2024-07-01',
                    certEnd: '2025-06-30',
                    burdenRatio: '2',
                    address: 'æ±äº¬éƒ½æ¸¯åŒºâ—‹â—‹3-3-3',
                    tel: '03-5555-6666',
                    hokenshaNo: '131032',
                    hokenshaName: 'æ¸¯åŒº'
                }
            ];

            // ã‚µãƒ³ãƒ—ãƒ«ã‚µãƒ¼ãƒ“ã‚¹å®Ÿç¸¾
            const currentMonth = new Date().toISOString().slice(0, 7);
            services = [
                { userId: 1, month: currentMonth, serviceCode: '111111', count: 8 },
                { userId: 1, month: currentMonth, serviceCode: '112111', count: 4 },
                { userId: 2, month: currentMonth, serviceCode: '111112', count: 6 },
                { userId: 2, month: currentMonth, serviceCode: '112112', count: 8 },
                { userId: 3, month: currentMonth, serviceCode: '111111', count: 4 },
                { userId: 3, month: currentMonth, serviceCode: '113111', count: 4 }
            ];

            renderUserTable();
            updateUserSelects();
        }

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu li').forEach(l => l.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');

            if (pageId === 'dashboard') {
                updateDashboard();
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            document.getElementById('totalUsers').innerHTML = users.length + '<span class="unit">å</span>';

            const currentMonth = document.getElementById('serviceMonth')?.value || new Date().toISOString().slice(0, 7);
            const monthServices = services.filter(s => s.month === currentMonth);

            let totalServiceCount = 0;
            let totalUnits = 0;

            monthServices.forEach(s => {
                totalServiceCount += s.count;
                const code = serviceCodeMaster.find(c => c.code === s.serviceCode);
                if (code) {
                    totalUnits += code.units * s.count;
                }
            });

            document.getElementById('totalServices').innerHTML = totalServiceCount + '<span class="unit">å›</span>';

            const totalAmount = Math.floor(totalUnits * unitPrice);
            document.getElementById('totalBilling').innerHTML =
                totalAmount.toLocaleString() + '<span class="unit">å††</span>';

            document.getElementById('unbilledCount').innerHTML =
                users.length + '<span class="unit">ä»¶</span>';

            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«
            const tbody = document.getElementById('dashboardTable');
            tbody.innerHTML = '';

            users.forEach(user => {
                const userServices = monthServices.filter(s => s.userId === user.id);
                let userUnits = 0;

                userServices.forEach(s => {
                    const code = serviceCodeMaster.find(c => c.code === s.serviceCode);
                    if (code) {
                        userUnits += code.units * s.count;
                    }
                });

                const serviceCount = userServices.reduce((sum, s) => sum + s.count, 0);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.name}</td>
                    <td>${careLevelMaster[user.careLevel].name}</td>
                    <td>è¨ªå•ä»‹è­·</td>
                    <td>${serviceCount}å›</td>
                    <td>${userUnits.toLocaleString()}å˜ä½</td>
                    <td><span class="badge badge-yellow">æœªè«‹æ±‚</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // åˆ©ç”¨è€…ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderUserTable() {
            const tbody = document.getElementById('userTable');
            tbody.innerHTML = '';

            users.forEach(user => {
                const careLevel = careLevelMaster[user.careLevel];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.hihokenNo}</td>
                    <td>${user.name}</td>
                    <td>${formatDate(user.birthDate)}</td>
                    <td><span class="badge badge-blue">${careLevel.name}</span></td>
                    <td>${formatDate(user.certStart)} ï½ ${formatDate(user.certEnd)}</td>
                    <td>${careLevel.limit.toLocaleString()}å˜ä½</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="editUser(${user.id})">ç·¨é›†</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteUser(${user.id})">å‰Šé™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
        }

        // åˆ©ç”¨è€…é¸æŠè‚¢æ›´æ–°
        function updateUserSelects() {
            const selects = ['serviceUser', 'carePlanUser', 'reportUser'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;

                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.hihokenNo} - ${user.name}`;
                    select.appendChild(option);
                });
            });
        }

        // åˆ©ç”¨è€…ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showUserModal() {
            document.getElementById('userModal').classList.add('show');
            clearUserModal();
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
        }

        function clearUserModal() {
            document.getElementById('modalHihokenNo').value = '';
            document.getElementById('modalUserName').value = '';
            document.getElementById('modalUserKana').value = '';
            document.getElementById('modalBirthDate').value = '';
            document.getElementById('modalGender').value = '1';
            document.getElementById('modalCareLevel').value = '21';
            document.getElementById('modalCertStart').value = '';
            document.getElementById('modalCertEnd').value = '';
            document.getElementById('modalBurdenRatio').value = '1';
            document.getElementById('modalAddress').value = '';
            document.getElementById('modalTel').value = '';
            document.getElementById('modalHokenshaNo').value = '';
            document.getElementById('modalHokenshaName').value = '';
        }

        function saveUser() {
            const user = {
                id: users.length + 1,
                hihokenNo: document.getElementById('modalHihokenNo').value,
                name: document.getElementById('modalUserName').value,
                kana: document.getElementById('modalUserKana').value,
                birthDate: document.getElementById('modalBirthDate').value,
                gender: document.getElementById('modalGender').value,
                careLevel: document.getElementById('modalCareLevel').value,
                certStart: document.getElementById('modalCertStart').value,
                certEnd: document.getElementById('modalCertEnd').value,
                burdenRatio: document.getElementById('modalBurdenRatio').value,
                address: document.getElementById('modalAddress').value,
                tel: document.getElementById('modalTel').value,
                hokenshaNo: document.getElementById('modalHokenshaNo').value,
                hokenshaName: document.getElementById('modalHokenshaName').value
            };

            if (!user.hihokenNo || !user.name || !user.birthDate) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            users.push(user);
            renderUserTable();
            updateUserSelects();
            closeUserModal();
            alert('åˆ©ç”¨è€…ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('modalHihokenNo').value = user.hihokenNo;
            document.getElementById('modalUserName').value = user.name;
            document.getElementById('modalUserKana').value = user.kana;
            document.getElementById('modalBirthDate').value = user.birthDate;
            document.getElementById('modalGender').value = user.gender;
            document.getElementById('modalCareLevel').value = user.careLevel;
            document.getElementById('modalCertStart').value = user.certStart;
            document.getElementById('modalCertEnd').value = user.certEnd;
            document.getElementById('modalBurdenRatio').value = user.burdenRatio;
            document.getElementById('modalAddress').value = user.address;
            document.getElementById('modalTel').value = user.tel;
            document.getElementById('modalHokenshaNo').value = user.hokenshaNo;
            document.getElementById('modalHokenshaName').value = user.hokenshaName;

            document.getElementById('userModal').classList.add('show');
        }

        function deleteUser(id) {
            if (confirm('ã“ã®åˆ©ç”¨è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                users = users.filter(u => u.id !== id);
                renderUserTable();
                updateUserSelects();
            }
        }

        function searchUsers() {
            const keyword = document.getElementById('userSearch').value.toLowerCase();
            const tbody = document.getElementById('userTable');
            tbody.innerHTML = '';

            const filtered = users.filter(u =>
                u.name.toLowerCase().includes(keyword) ||
                u.hihokenNo.toLowerCase().includes(keyword)
            );

            filtered.forEach(user => {
                const careLevel = careLevelMaster[user.careLevel];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.hihokenNo}</td>
                    <td>${user.name}</td>
                    <td>${formatDate(user.birthDate)}</td>
                    <td><span class="badge badge-blue">${careLevel.name}</span></td>
                    <td>${formatDate(user.certStart)} ï½ ${formatDate(user.certEnd)}</td>
                    <td>${careLevel.limit.toLocaleString()}å˜ä½</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="editUser(${user.id})">ç·¨é›†</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteUser(${user.id})">å‰Šé™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ã‚µãƒ¼ãƒ“ã‚¹å®Ÿç¸¾å…¥åŠ›
        function loadUserServices() {
            const userId = parseInt(document.getElementById('serviceUser').value);
            const month = document.getElementById('serviceMonth').value;

            if (!userId || !month) {
                document.getElementById('serviceInputArea').style.display = 'none';
                return;
            }

            document.getElementById('serviceInputArea').style.display = 'block';

            const user = users.find(u => u.id === userId);
            const careLevel = careLevelMaster[user.careLevel];

            document.getElementById('userServiceInfo').innerHTML = `
                <p><strong>${user.name}</strong> (${careLevel.name}) - æ”¯çµ¦é™åº¦é¡: ${careLevel.limit.toLocaleString()}å˜ä½</p>
            `;

            renderServiceCalendar(month, userId);
            renderServiceInputTable(userId, month);
        }

        function renderServiceCalendar(month, userId) {
            const calendar = document.getElementById('serviceCalendar');
            calendar.innerHTML = '';

            const [year, mon] = month.split('-').map(Number);
            const firstDay = new Date(year, mon - 1, 1);
            const lastDay = new Date(year, mon, 0);
            const startDayOfWeek = firstDay.getDay();

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            // ç©ºç™½
            for (let i = 0; i < startDayOfWeek; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day';
                calendar.appendChild(empty);
            }

            // æ—¥ä»˜
            const userServices = services.filter(s => s.userId === userId && s.month === month);

            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dayEl = document.createElement('div');
                const dayOfWeek = new Date(year, mon - 1, d).getDay();
                dayEl.className = 'calendar-day';
                if (dayOfWeek === 0) dayEl.classList.add('sunday');
                if (dayOfWeek === 6) dayEl.classList.add('saturday');

                dayEl.innerHTML = `<div class="date">${d}</div>`;

                // ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹æ—¥ã«è¡¨ç¤ºï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
                if (userServices.length > 0 && (d % 3 === 0 || d % 5 === 0)) {
                    dayEl.innerHTML += `<div class="service">è¨ªå•</div>`;
                }

                calendar.appendChild(dayEl);
            }
        }

        function renderServiceInputTable(userId, month) {
            const tbody = document.getElementById('serviceInputTable');
            tbody.innerHTML = '';

            const userServices = services.filter(s => s.userId === userId && s.month === month);

            serviceCodeMaster.forEach(code => {
                const existing = userServices.find(s => s.serviceCode === code.code);
                const count = existing ? existing.count : 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${code.code}</td>
                    <td>${code.name}</td>
                    <td>${code.units}</td>
                    <td><input type="number" min="0" value="${count}" data-code="${code.code}" data-units="${code.units}" onchange="calculateTotals()"></td>
                    <td class="subtotal">${code.units * count}</td>
                `;
                tbody.appendChild(tr);
            });

            calculateTotals();
        }

        function calculateTotals() {
            const userId = parseInt(document.getElementById('serviceUser').value);
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const careLevel = careLevelMaster[user.careLevel];
            const limit = careLevel.limit;

            let total = 0;
            document.querySelectorAll('#serviceInputTable input').forEach(input => {
                const units = parseInt(input.dataset.units);
                const count = parseInt(input.value) || 0;
                const subtotal = units * count;
                input.closest('tr').querySelector('.subtotal').textContent = subtotal;
                total += subtotal;
            });

            document.getElementById('totalUnits').textContent = total;
            document.getElementById('limitUnits').textContent = Math.min(total, limit);
            document.getElementById('overUnits').textContent = Math.max(0, total - limit);
        }

        function saveServices() {
            const userId = parseInt(document.getElementById('serviceUser').value);
            const month = document.getElementById('serviceMonth').value;

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            services = services.filter(s => !(s.userId === userId && s.month === month));

            // æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            document.querySelectorAll('#serviceInputTable input').forEach(input => {
                const count = parseInt(input.value) || 0;
                if (count > 0) {
                    services.push({
                        userId: userId,
                        month: month,
                        serviceCode: input.dataset.code,
                        count: count
                    });
                }
            });

            alert('ã‚µãƒ¼ãƒ“ã‚¹å®Ÿç¸¾ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
            updateDashboard();
        }

        function clearServices() {
            document.querySelectorAll('#serviceInputTable input').forEach(input => {
                input.value = 0;
            });
            calculateTotals();
        }

        // ã‚±ã‚¢ãƒ—ãƒ©ãƒ³
        function loadCarePlan() {
            const userId = parseInt(document.getElementById('carePlanUser').value);
            if (!userId) {
                document.getElementById('carePlanArea').style.display = 'none';
                return;
            }

            document.getElementById('carePlanArea').style.display = 'block';

            // é€±é–“ã‚µãƒ¼ãƒ“ã‚¹è¨ˆç”»ãƒ†ãƒ¼ãƒ–ãƒ«
            const tbody = document.getElementById('weeklyPlanTable');
            tbody.innerHTML = '';

            ['è¨ªå•ä»‹è­·ï¼ˆèº«ä½“ï¼‰', 'è¨ªå•ä»‹è­·ï¼ˆç”Ÿæ´»ï¼‰', 'é€šæ‰€ä»‹è­·', 'è¨ªå•çœ‹è­·'].forEach(service => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${service}</td>
                    <td><input type="text" style="width: 60px;"></td>
                    <td><input type="text" style="width: 60px;"></td>
                    <td><input type="text" style="width: 60px;"></td>
                    <td><input type="text" style="width: 60px;"></td>
                    <td><input type="text" style="width: 60px;"></td>
                    <td><input type="text" style="width: 60px;"></td>
                    <td><input type="text" style="width: 60px;"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveCarePlan() {
            alert('ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }

        function printCarePlan() {
            window.print();
        }

        // è«‹æ±‚å‡¦ç†
        function generateBillingData() {
            const month = document.getElementById('billingMonth').value;
            if (!month) {
                alert('è«‹æ±‚å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            document.getElementById('billingResult').style.display = 'block';

            const tbody = document.getElementById('billingTable');
            tbody.innerHTML = '';

            let totalInsurance = 0;
            let totalUserCharge = 0;

            users.forEach(user => {
                const userServices = services.filter(s => s.userId === user.id && s.month === month);
                if (userServices.length === 0) return;

                let totalUnits = 0;
                userServices.forEach(s => {
                    const code = serviceCodeMaster.find(c => c.code === s.serviceCode);
                    if (code) {
                        totalUnits += code.units * s.count;
                    }
                });

                const careLevel = careLevelMaster[user.careLevel];
                const limitUnits = Math.min(totalUnits, careLevel.limit);
                const totalAmount = Math.floor(limitUnits * unitPrice);
                const burdenRatio = parseInt(user.burdenRatio) / 10;
                const userCharge = Math.floor(totalAmount * burdenRatio);
                const insuranceAmount = totalAmount - userCharge;

                totalInsurance += insuranceAmount;
                totalUserCharge += userCharge;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.hihokenNo}</td>
                    <td>${user.name}</td>
                    <td>è¨ªå•ä»‹è­·</td>
                    <td>${totalUnits.toLocaleString()}</td>
                    <td>${insuranceAmount.toLocaleString()}å††</td>
                    <td>${userCharge.toLocaleString()}å††</td>
                    <td><span class="badge badge-yellow">æœªç¢ºå®š</span></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totalInsurance').textContent = totalInsurance.toLocaleString() + 'å††';
            document.getElementById('totalUserCharge').textContent = totalUserCharge.toLocaleString() + 'å††';
        }

        function confirmBilling() {
            if (confirm('è«‹æ±‚ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿç¢ºå®šå¾Œã¯ä¿®æ­£ã§ãã¾ã›ã‚“ã€‚')) {
                document.querySelectorAll('#billingTable .badge').forEach(badge => {
                    badge.className = 'badge badge-green';
                    badge.textContent = 'ç¢ºå®šæ¸ˆ';
                });
                alert('è«‹æ±‚ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚');
            }
        }

        function exportCSV() {
            let csv = 'è¢«ä¿é™ºè€…ç•ªå·,åˆ©ç”¨è€…å,ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡,å˜ä½æ•°,ä¿é™ºè«‹æ±‚é¡,åˆ©ç”¨è€…è² æ‹…é¡\n';

            document.querySelectorAll('#billingTable tr').forEach(tr => {
                const cells = tr.querySelectorAll('td');
                if (cells.length > 0) {
                    const row = [
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].textContent
                    ].join(',');
                    csv += row + '\n';
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è«‹æ±‚ãƒ‡ãƒ¼ã‚¿_${document.getElementById('billingMonth').value}.csv`;
            link.click();
        }

        // å¸³ç¥¨å‡ºåŠ›
        function previewReport() {
            const reportType = document.getElementById('reportType').value;
            const month = document.getElementById('reportMonth').value;
            const userId = document.getElementById('reportUser').value;

            if (!month) {
                alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            document.getElementById('reportPreview').style.display = 'block';
            const printArea = document.getElementById('printArea');

            if (reportType === 'meisai') {
                renderMeisai(printArea, month, userId);
            } else if (reportType === 'seikyu') {
                renderSeikyu(printArea, month);
            } else if (reportType === 'ryoshu') {
                renderRyoshu(printArea, month, userId);
            }
        }

        function renderMeisai(container, month, userId) {
            const targetUsers = userId === 'all' ? users : users.filter(u => u.id === parseInt(userId));
            if (targetUsers.length === 0) return;

            const user = targetUsers[0];
            const careLevel = careLevelMaster[user.careLevel];
            const userServices = services.filter(s => s.userId === user.id && s.month === month);

            let serviceRows = '';
            let totalUnits = 0;

            userServices.forEach(s => {
                const code = serviceCodeMaster.find(c => c.code === s.serviceCode);
                if (code) {
                    const subtotal = code.units * s.count;
                    totalUnits += subtotal;
                    serviceRows += `
                        <tr>
                            <td>${code.code}</td>
                            <td>${code.name}</td>
                            <td style="text-align: right;">${code.units}</td>
                            <td style="text-align: right;">${s.count}</td>
                            <td style="text-align: right;">${subtotal}</td>
                        </tr>
                    `;
                }
            });

            const totalAmount = Math.floor(totalUnits * unitPrice);
            const burdenRatio = parseInt(user.burdenRatio) / 10;
            const userCharge = Math.floor(totalAmount * burdenRatio);
            const insuranceAmount = totalAmount - userCharge;

            container.innerHTML = `
                <div class="print-header">
                    <h2>ä»‹è­·çµ¦ä»˜è²»æ˜ç´°æ›¸</h2>
                    <p>ã‚µãƒ¼ãƒ“ã‚¹æä¾›å¹´æœˆ: ${month.replace('-', 'å¹´')}æœˆ</p>
                </div>

                <div class="print-info">
                    <div>
                        <p><strong>äº‹æ¥­æ‰€ç•ªå·:</strong> 1234567890</p>
                        <p><strong>äº‹æ¥­æ‰€å:</strong> ã‚µãƒ³ãƒ—ãƒ«ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹äº‹æ¥­æ‰€</p>
                    </div>
                    <div>
                        <p><strong>ä¿é™ºè€…ç•ªå·:</strong> ${user.hokenshaNo}</p>
                        <p><strong>ä¿é™ºè€…å:</strong> ${user.hokenshaName}</p>
                    </div>
                </div>

                <table class="print-table">
                    <tr>
                        <th>è¢«ä¿é™ºè€…ç•ªå·</th>
                        <td>${user.hihokenNo}</td>
                        <th>è¢«ä¿é™ºè€…æ°å</th>
                        <td>${user.name}</td>
                    </tr>
                    <tr>
                        <th>ç”Ÿå¹´æœˆæ—¥</th>
                        <td>${formatDate(user.birthDate)}</td>
                        <th>è¦ä»‹è­·çŠ¶æ…‹åŒºåˆ†</th>
                        <td>${careLevel.name}</td>
                    </tr>
                    <tr>
                        <th>èªå®šæœ‰åŠ¹æœŸé–“</th>
                        <td colspan="3">${formatDate(user.certStart)} ï½ ${formatDate(user.certEnd)}</td>
                    </tr>
                </table>

                <h4 style="margin: 20px 0 10px;">ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹</h4>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰</th>
                            <th>ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹</th>
                            <th>å˜ä½æ•°</th>
                            <th>å›æ•°</th>
                            <th>ã‚µãƒ¼ãƒ“ã‚¹å˜ä½æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${serviceRows}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4" style="text-align: right;">åˆè¨ˆå˜ä½æ•°</th>
                            <td style="text-align: right;"><strong>${totalUnits}</strong></td>
                        </tr>
                    </tfoot>
                </table>

                <table class="print-table" style="margin-top: 20px;">
                    <tr>
                        <th>æ”¯çµ¦é™åº¦åŸºæº–é¡</th>
                        <td style="text-align: right;">${careLevel.limit.toLocaleString()} å˜ä½</td>
                    </tr>
                    <tr>
                        <th>å˜ä½æ•°å˜ä¾¡</th>
                        <td style="text-align: right;">${unitPrice} å††</td>
                    </tr>
                    <tr>
                        <th>ä¿é™ºè«‹æ±‚é¡</th>
                        <td style="text-align: right;">${insuranceAmount.toLocaleString()} å††</td>
                    </tr>
                    <tr>
                        <th>åˆ©ç”¨è€…è² æ‹…é¡ï¼ˆ${user.burdenRatio}å‰²ï¼‰</th>
                        <td style="text-align: right;">${userCharge.toLocaleString()} å††</td>
                    </tr>
                </table>
            `;
        }

        function renderSeikyu(container, month) {
            let totalUnits = 0;
            let totalInsurance = 0;
            let totalUserCharge = 0;
            let userCount = 0;

            users.forEach(user => {
                const userServices = services.filter(s => s.userId === user.id && s.month === month);
                if (userServices.length === 0) return;

                userCount++;
                let units = 0;
                userServices.forEach(s => {
                    const code = serviceCodeMaster.find(c => c.code === s.serviceCode);
                    if (code) {
                        units += code.units * s.count;
                    }
                });

                totalUnits += units;
                const amount = Math.floor(units * unitPrice);
                const burdenRatio = parseInt(user.burdenRatio) / 10;
                const userCharge = Math.floor(amount * burdenRatio);
                totalInsurance += amount - userCharge;
                totalUserCharge += userCharge;
            });

            container.innerHTML = `
                <div class="print-header">
                    <h2>ä»‹è­·çµ¦ä»˜è²»è«‹æ±‚æ›¸</h2>
                    <p>ã‚µãƒ¼ãƒ“ã‚¹æä¾›å¹´æœˆ: ${month.replace('-', 'å¹´')}æœˆ</p>
                </div>

                <table class="print-table">
                    <tr>
                        <th>äº‹æ¥­æ‰€ç•ªå·</th>
                        <td>1234567890</td>
                    </tr>
                    <tr>
                        <th>äº‹æ¥­æ‰€åç§°</th>
                        <td>ã‚µãƒ³ãƒ—ãƒ«ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹äº‹æ¥­æ‰€</td>
                    </tr>
                    <tr>
                        <th>æ‰€åœ¨åœ°</th>
                        <td>æ±äº¬éƒ½åƒä»£ç”°åŒºâ—‹â—‹1-2-3</td>
                    </tr>
                    <tr>
                        <th>ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡</th>
                        <td>è¨ªå•ä»‹è­·</td>
                    </tr>
                </table>

                <h4 style="margin: 20px 0 10px;">è«‹æ±‚å†…å®¹</h4>
                <table class="print-table">
                    <tr>
                        <th>ä»¶æ•°</th>
                        <td style="text-align: right;">${userCount} ä»¶</td>
                    </tr>
                    <tr>
                        <th>å˜ä½æ•°</th>
                        <td style="text-align: right;">${totalUnits.toLocaleString()} å˜ä½</td>
                    </tr>
                    <tr>
                        <th>ä¿é™ºè«‹æ±‚é¡</th>
                        <td style="text-align: right;"><strong>${totalInsurance.toLocaleString()} å††</strong></td>
                    </tr>
                    <tr>
                        <th>åˆ©ç”¨è€…è² æ‹…é¡</th>
                        <td style="text-align: right;">${totalUserCharge.toLocaleString()} å††</td>
                    </tr>
                </table>
            `;
        }

        function renderRyoshu(container, month, userId) {
            const targetUsers = userId === 'all' ? users : users.filter(u => u.id === parseInt(userId));
            if (targetUsers.length === 0) return;

            const user = targetUsers[0];
            const userServices = services.filter(s => s.userId === user.id && s.month === month);

            let totalUnits = 0;
            userServices.forEach(s => {
                const code = serviceCodeMaster.find(c => c.code === s.serviceCode);
                if (code) {
                    totalUnits += code.units * s.count;
                }
            });

            const totalAmount = Math.floor(totalUnits * unitPrice);
            const burdenRatio = parseInt(user.burdenRatio) / 10;
            const userCharge = Math.floor(totalAmount * burdenRatio);

            const today = new Date();

            container.innerHTML = `
                <div class="print-header">
                    <h2>é ˜ å æ›¸</h2>
                </div>

                <div style="text-align: right; margin-bottom: 20px;">
                    <p>ç™ºè¡Œæ—¥: ${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥</p>
                    <p>No. ${Math.floor(Math.random() * 10000)}</p>
                </div>

                <div style="margin-bottom: 30px;">
                    <p style="font-size: 18px;"><strong>${user.name}</strong> æ§˜</p>
                </div>

                <div style="text-align: center; margin: 30px 0; padding: 20px; border: 2px solid #333;">
                    <p style="font-size: 14px;">é‡‘é¡</p>
                    <p style="font-size: 28px; font-weight: bold;">Â¥ ${userCharge.toLocaleString()}-</p>
                </div>

                <table class="print-table">
                    <tr>
                        <th>ã‚µãƒ¼ãƒ“ã‚¹æä¾›å¹´æœˆ</th>
                        <td>${month.replace('-', 'å¹´')}æœˆ</td>
                    </tr>
                    <tr>
                        <th>ã‚µãƒ¼ãƒ“ã‚¹ç¨®é¡</th>
                        <td>è¨ªå•ä»‹è­·</td>
                    </tr>
                    <tr>
                        <th>ä¿é™ºçµ¦ä»˜é¡</th>
                        <td style="text-align: right;">${(totalAmount - userCharge).toLocaleString()} å††</td>
                    </tr>
                    <tr>
                        <th>åˆ©ç”¨è€…è² æ‹…é¡ï¼ˆ${user.burdenRatio}å‰²ï¼‰</th>
                        <td style="text-align: right;">${userCharge.toLocaleString()} å††</td>
                    </tr>
                </table>

                <div style="margin-top: 40px;">
                    <p>ä¸Šè¨˜ã®é‡‘é¡ã‚’é ˜åã„ãŸã—ã¾ã—ãŸã€‚</p>
                </div>

                <div style="margin-top: 40px; text-align: right;">
                    <p>äº‹æ¥­æ‰€ç•ªå·: 1234567890</p>
                    <p><strong>ã‚µãƒ³ãƒ—ãƒ«ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹äº‹æ¥­æ‰€</strong></p>
                    <p>æ±äº¬éƒ½åƒä»£ç”°åŒºâ—‹â—‹1-2-3</p>
                    <p>TEL: 03-1234-5678</p>
                </div>
            `;
        }

        function printReport() {
            window.print();
        }

        // ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«
        function renderServiceCodeTable() {
            const tbody = document.getElementById('serviceCodeTable');
            tbody.innerHTML = '';

            serviceCodeMaster.forEach(code => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${code.code}</td>
                    <td>${code.name}</td>
                    <td>${code.units}</td>
                    <td>${code.unit_type}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveMaster() {
            alert('äº‹æ¥­æ‰€æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }
    </script>
</body>
</html>
