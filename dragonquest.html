<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éâ„É©„Ç¥„É≥„ÇØ„Ç®„Çπ„ÉàÈ¢®RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'MS Gothic', 'Hiragino Kaku Gothic Pro', monospace;
            image-rendering: pixelated;
        }

        .game-container {
            width: 640px;
            height: 480px;
            background: #000;
            position: relative;
            border: 4px solid #fff;
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
        }

        .message-window {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: #000;
            border: 4px solid #fff;
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            font-size: 18px;
            line-height: 1.6;
            display: none;
            min-height: 100px;
        }

        .message-window.show {
            display: block;
        }

        .message-text {
            white-space: pre-wrap;
        }

        .message-cursor {
            display: inline-block;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .battle-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #001133 0%, #002266 50%, #003399 100%);
            display: none;
            flex-direction: column;
        }

        .battle-screen.show {
            display: flex;
        }

        .enemy-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .enemy-sprite {
            font-size: 120px;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.5);
            animation: enemyIdle 2s ease-in-out infinite;
        }

        @keyframes enemyIdle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .enemy-name {
            color: #fff;
            font-size: 20px;
            margin-top: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .battle-ui {
            background: #000;
            border-top: 4px solid #fff;
            padding: 10px;
        }

        .status-panel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .player-status {
            background: #000;
            border: 3px solid #fff;
            padding: 10px 20px;
            color: #fff;
        }

        .player-status .name {
            color: #ffcc00;
            margin-bottom: 5px;
        }

        .hp-bar, .mp-bar {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }

        .hp-bar span, .mp-bar span {
            width: 30px;
        }

        .bar-container {
            width: 100px;
            height: 12px;
            background: #333;
            margin-left: 10px;
            border: 1px solid #fff;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .hp-bar .bar-fill {
            background: #00ff00;
        }

        .mp-bar .bar-fill {
            background: #00ccff;
        }

        .battle-menu {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .menu-item {
            background: #000;
            border: 3px solid #fff;
            color: #fff;
            padding: 10px 25px;
            font-size: 16px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .menu-item:hover, .menu-item.selected {
            background: #fff;
            color: #000;
        }

        .battle-message {
            background: #000;
            border: 3px solid #fff;
            padding: 10px;
            color: #fff;
            font-size: 16px;
            margin-top: 10px;
            min-height: 50px;
            text-align: center;
        }

        .damage-number {
            position: absolute;
            font-size: 36px;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 2px 2px 0 #000;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
        }

        .damage-number.heal {
            color: #44ff44;
        }

        @keyframes damageFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        .title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #000033 0%, #000066 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
        }

        .title-screen h1 {
            font-size: 36px;
            color: #ffcc00;
            text-shadow: 4px 4px 0 #aa6600;
            margin-bottom: 20px;
            letter-spacing: 8px;
        }

        .title-screen h2 {
            font-size: 24px;
            margin-bottom: 60px;
            color: #88ccff;
        }

        .title-screen .start-btn {
            background: transparent;
            border: 3px solid #fff;
            color: #fff;
            padding: 15px 50px;
            font-size: 20px;
            cursor: pointer;
            font-family: inherit;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .title-screen .start-btn:hover {
            background: #fff;
            color: #000;
        }

        .game-clear {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #330000 0%, #660033 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
        }

        .game-clear.show {
            display: flex;
        }

        .game-clear h1 {
            font-size: 48px;
            color: #ffcc00;
            text-shadow: 4px 4px 0 #aa6600;
            margin-bottom: 30px;
        }

        .game-clear p {
            font-size: 20px;
            margin-bottom: 40px;
        }

        .spell-menu {
            display: none;
            flex-direction: column;
            gap: 5px;
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            border: 3px solid #fff;
            padding: 10px;
        }

        .spell-menu.show {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas" width="640" height="480"></canvas>

        <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
        <div class="title-screen" id="titleScreen">
            <h1>ÂãáËÄÖ„ÅÆÂÜíÈô∫</h1>
            <h2>„Äú È≠îÁéã„ÇíÂÄí„Åõ „Äú</h2>
            <button class="start-btn" onclick="startGame()">„Çπ„Çø„Éº„Éà</button>
            <p style="margin-top: 40px; font-size: 14px; color: #888;">Áü¢Âç∞„Ç≠„Éº„ÅßÁßªÂãï / Space„ÅßÊ±∫ÂÆö</p>
        </div>

        <!-- „Éï„Ç£„Éº„É´„Éâ„É°„ÉÉ„Çª„Éº„Ç∏ -->
        <div class="message-window" id="messageWindow">
            <div class="message-text" id="messageText"></div>
            <span class="message-cursor">‚ñº</span>
        </div>

        <!-- „Éê„Éà„É´ÁîªÈù¢ -->
        <div class="battle-screen" id="battleScreen">
            <div class="enemy-area">
                <div class="enemy-sprite" id="enemySprite"></div>
                <div class="enemy-name" id="enemyName"></div>
            </div>
            <div class="battle-ui">
                <div class="status-panel">
                    <div class="player-status">
                        <div class="name">„ÇÜ„ÅÜ„Åó„ÇÉ</div>
                        <div class="hp-bar">
                            <span>HP</span>
                            <span id="hpText">100</span>
                            <div class="bar-container">
                                <div class="bar-fill" id="hpBar" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="mp-bar">
                            <span>MP</span>
                            <span id="mpText">30</span>
                            <div class="bar-container">
                                <div class="bar-fill" id="mpBar" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="player-status">
                        <div>LV: <span id="lvText">1</span></div>
                        <div>EXP: <span id="expText">0</span></div>
                        <div>G: <span id="goldText">0</span></div>
                    </div>
                </div>
                <div class="battle-menu" id="battleMenu">
                    <button class="menu-item" onclick="battleAction('attack')">„Åü„Åü„Åã„ÅÜ</button>
                    <button class="menu-item" onclick="battleAction('spell')">„Åò„ÇÖ„ÇÇ„Çì</button>
                    <button class="menu-item" onclick="battleAction('item')">„Å©„ÅÜ„Åê</button>
                    <button class="menu-item" onclick="battleAction('run')">„Å´„Åí„Çã</button>
                </div>
                <div class="spell-menu" id="spellMenu">
                    <button class="menu-item" onclick="castSpell('hoimi')">„Éõ„Ç§„Éü (MP3)</button>
                    <button class="menu-item" onclick="castSpell('gira')">„ÇÆ„É© (MP4)</button>
                    <button class="menu-item" onclick="closeSpellMenu()">„ÇÇ„Å©„Çã</button>
                </div>
                <div class="battle-message" id="battleMessage">
                    „É¢„É≥„Çπ„Çø„Éº„Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ
                </div>
            </div>
        </div>

        <!-- „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÁîªÈù¢ -->
        <div class="game-clear" id="gameClear">
            <h1>CONGRATULATIONS!</h1>
            <p>È≠îÁéã„ÇíÂÄí„Åó„ÄÅ‰∏ñÁïå„Å´Âπ≥Âíå„ÅåÊàª„Å£„ÅüÔºÅ</p>
            <button class="menu-item" onclick="location.reload()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å∂</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // „Ç≤„Éº„É†Áä∂ÊÖã
        const GAME_STATE = {
            TITLE: 'title',
            FIELD: 'field',
            MESSAGE: 'message',
            BATTLE: 'battle',
            BATTLE_ANIMATION: 'battle_animation',
            CLEAR: 'clear'
        };

        let gameState = GAME_STATE.TITLE;

        // „Éó„É¨„Ç§„É§„Éº„Çπ„ÉÜ„Éº„Çø„Çπ
        const player = {
            x: 5,
            y: 5,
            hp: 100,
            maxHp: 100,
            mp: 30,
            maxMp: 30,
            level: 1,
            exp: 0,
            gold: 0,
            attack: 15,
            defense: 5,
            potions: 3
        };

        // „Éû„ÉÉ„Éó„Éá„Éº„Çø
        const TILE = {
            GRASS: 0,
            WATER: 1,
            TREE: 2,
            MOUNTAIN: 3,
            CASTLE: 4,
            TOWN: 5,
            CAVE: 6,
            BRIDGE: 7
        };

        const TILE_COLORS = {
            [TILE.GRASS]: '#228B22',
            [TILE.WATER]: '#1E90FF',
            [TILE.TREE]: '#006400',
            [TILE.MOUNTAIN]: '#8B4513',
            [TILE.CASTLE]: '#FFD700',
            [TILE.TOWN]: '#DEB887',
            [TILE.CAVE]: '#4B0082',
            [TILE.BRIDGE]: '#8B4513'
        };

        const TILE_CHARS = {
            [TILE.GRASS]: '',
            [TILE.WATER]: '„Äú',
            [TILE.TREE]: 'üå≤',
            [TILE.MOUNTAIN]: '‚õ∞Ô∏è',
            [TILE.CASTLE]: 'üè∞',
            [TILE.TOWN]: 'üè†',
            [TILE.CAVE]: 'üï≥Ô∏è',
            [TILE.BRIDGE]: '‚ïê'
        };

        // 20x15„ÅÆ„Éû„ÉÉ„Éó
        const map = [
            [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
            [3,0,0,0,2,2,0,0,0,0,1,1,1,0,0,0,2,2,0,3],
            [3,0,4,0,0,2,0,0,0,1,1,1,1,1,0,0,0,2,0,3],
            [3,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,3],
            [3,2,0,0,0,0,0,0,0,0,7,7,0,0,0,0,0,0,2,3],
            [3,2,2,0,0,5,0,0,0,0,0,0,0,0,0,5,0,0,2,3],
            [3,0,0,0,0,0,0,0,2,2,0,0,2,2,0,0,0,0,0,3],
            [3,0,0,0,2,0,0,2,2,2,0,0,2,2,2,0,0,0,0,3],
            [3,0,0,0,2,0,0,0,2,0,0,0,0,2,0,0,0,0,0,3],
            [3,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,3],
            [3,1,1,1,0,0,0,0,0,0,6,0,0,0,0,0,1,1,1,3],
            [3,1,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,1,1,3],
            [3,0,0,0,0,2,2,0,0,0,0,0,0,0,2,2,0,0,0,3],
            [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
            [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]
        ];

        const TILE_SIZE = 32;

        // „É¢„É≥„Çπ„Çø„Éº„Éá„Éº„Çø
        const monsters = {
            slime: {
                name: '„Çπ„É©„Ç§„É†',
                sprite: 'üü¢',
                hp: 15,
                attack: 5,
                defense: 2,
                exp: 5,
                gold: 3
            },
            ghost: {
                name: '„Ç¥„Éº„Çπ„Éà',
                sprite: 'üëª',
                hp: 25,
                attack: 10,
                defense: 3,
                exp: 12,
                gold: 8
            },
            skeleton: {
                name: '„Åå„ÅÑ„Åì„Å§',
                sprite: 'üíÄ',
                hp: 40,
                attack: 18,
                defense: 8,
                exp: 25,
                gold: 15
            },
            dragon: {
                name: '„Éâ„É©„Ç¥„É≥',
                sprite: 'üêâ',
                hp: 80,
                attack: 30,
                defense: 15,
                exp: 100,
                gold: 50
            },
            boss: {
                name: 'È≠îÁéã',
                sprite: 'üëø',
                hp: 200,
                attack: 45,
                defense: 20,
                exp: 500,
                gold: 1000,
                isBoss: true
            }
        };

        let currentEnemy = null;
        let inBattle = false;

        // „É°„ÉÉ„Çª„Éº„Ç∏„Ç≠„É•„Éº
        let messageQueue = [];
        let currentMessage = '';
        let messageCallback = null;

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            document.getElementById('titleScreen').style.display = 'none';
            gameState = GAME_STATE.FIELD;
            player.x = 3;
            player.y = 2;
            showMessage('„Åì„Åì„ÅØÂπ≥Âíå„Å™ÁéãÂõΩ„Å†„Å£„Åü...\n„Åó„Åã„ÅóÈ≠îÁéã„ÅåÁèæ„Çå„ÄÅ‰∏ñÁïå„ÅØÈóò„ÅÑ„Å´ÂåÖ„Åæ„Çå„Åü„ÄÇ\nÂãáËÄÖ„Çà„ÄÅÈ≠îÁéã„ÇíÂÄí„ÅóÂπ≥Âíå„ÇíÂèñ„ÇäÊàª„Åô„ÅÆ„Å†ÔºÅ', () => {
                gameState = GAME_STATE.FIELD;
            });
        }

        // ÊèèÁîª
        function drawField() {
            // „Éû„ÉÉ„ÉóÊèèÁîª
            for (let y = 0; y < 15; y++) {
                for (let x = 0; x < 20; x++) {
                    const tile = map[y][x];
                    ctx.fillStyle = TILE_COLORS[tile];
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);

                    // „Çø„Ç§„É´„ÅÆË£ÖÈ£æ
                    if (TILE_CHARS[tile]) {
                        ctx.font = '24px serif';
                        ctx.fillText(TILE_CHARS[tile], x * TILE_SIZE + 4, y * TILE_SIZE + 26);
                    }

                    // Ëçâ„Çø„Ç§„É´„Å´„É©„É≥„ÉÄ„É†„Å™Ê®°Êßò
                    if (tile === TILE.GRASS) {
                        ctx.fillStyle = '#1a7a1a';
                        if ((x + y) % 3 === 0) {
                            ctx.fillRect(x * TILE_SIZE + 10, y * TILE_SIZE + 10, 4, 4);
                        }
                    }
                }
            }

            // „Éó„É¨„Ç§„É§„ÉºÊèèÁîª
            ctx.font = '28px serif';
            ctx.fillText('üßô', player.x * TILE_SIZE + 2, player.y * TILE_SIZE + 28);

            // „Éü„Éã„Çπ„ÉÜ„Éº„Çø„Çπ
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(5, 5, 150, 60);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(5, 5, 150, 60);

            ctx.fillStyle = '#fff';
            ctx.font = '14px monospace';
            ctx.fillText(`LV:${player.level}  HP:${player.hp}/${player.maxHp}`, 12, 25);
            ctx.fillText(`MP:${player.mp}/${player.maxMp}  G:${player.gold}`, 12, 45);
            ctx.fillText(`„ÇÑ„Åè„Åù„ÅÜ:${player.potions}`, 12, 62);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (gameState === GAME_STATE.FIELD || gameState === GAME_STATE.MESSAGE) {
                drawField();
            }
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showMessage(text, callback = null) {
            gameState = GAME_STATE.MESSAGE;
            const msgWindow = document.getElementById('messageWindow');
            const msgText = document.getElementById('messageText');
            msgWindow.classList.add('show');
            msgText.textContent = text;
            messageCallback = callback;
        }

        function closeMessage() {
            const msgWindow = document.getElementById('messageWindow');
            msgWindow.classList.remove('show');
            if (messageCallback) {
                messageCallback();
                messageCallback = null;
            } else {
                gameState = GAME_STATE.FIELD;
            }
        }

        // ÁßªÂãïÂá¶ÁêÜ
        function movePlayer(dx, dy) {
            const newX = player.x + dx;
            const newY = player.y + dy;

            if (newX < 0 || newX >= 20 || newY < 0 || newY >= 15) return;

            const tile = map[newY][newX];

            // ÈÄöË°å‰∏çÂèØ„Çø„Ç§„É´
            if (tile === TILE.WATER || tile === TILE.MOUNTAIN) {
                return;
            }

            player.x = newX;
            player.y = newY;

            // „Ç§„Éô„É≥„Éà„ÉÅ„Çß„ÉÉ„ÇØ
            checkTileEvent(tile);

            // „É©„É≥„ÉÄ„É†„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÔºàËçâÂú∞„ÅÆ„ÅøÔºâ
            if (tile === TILE.GRASS && Math.random() < 0.1) {
                startBattle();
            }
        }

        function checkTileEvent(tile) {
            if (tile === TILE.CASTLE) {
                showMessage('ÁéãÊßò„ÄåÂãáËÄÖ„Çà„ÄÅÈ≠îÁéã„ÅØÂçó„ÅÆÊ¥ûÁ™ü„Å´„ÅÑ„Çã„ÄÇ\nÊ∞ó„Çí„Å§„Åë„Å¶Ë°å„Åè„ÅÆ„Å†ÔºÅ„Äç', () => {
                    player.hp = player.maxHp;
                    player.mp = player.maxMp;
                    showMessage('HP„Å®MP„ÅåÂõûÂæ©„Åó„ÅüÔºÅ');
                });
            } else if (tile === TILE.TOWN) {
                showMessage('ÂÆøÂ±ã„Äå„ÅäÁñ≤„ÇåÊßò„Åß„Åô„ÄÇ„ÇÜ„Å£„Åè„Çä‰ºë„Çì„Åß„ÅÑ„Å£„Å¶„Åè„Å†„Åï„ÅÑ„Äç', () => {
                    player.hp = player.maxHp;
                    player.mp = player.maxMp;
                    if (player.gold >= 10) {
                        player.gold -= 10;
                        player.potions++;
                        showMessage('HP„Å®MP„ÅåÂõûÂæ©„Åó„ÅüÔºÅ\n„ÇÑ„Åè„Åù„ÅÜ„Çí1„Å§Ë≥ºÂÖ•„Åó„ÅüÔºà10GÔºâ');
                    } else {
                        showMessage('HP„Å®MP„ÅåÂõûÂæ©„Åó„ÅüÔºÅ');
                    }
                });
            } else if (tile === TILE.CAVE) {
                showMessage('‰∏çÊ∞óÂë≥„Å™Ê¥ûÁ™ü„Å†...\nÂº∑Âäõ„Å™È≠îÁâ©„ÅÆÊ∞óÈÖç„Åå„Åô„ÇãÔºÅ', () => {
                    startBossBattle();
                });
            }
        }

        // „Éê„Éà„É´ÈñãÂßã
        function startBattle() {
            gameState = GAME_STATE.BATTLE;
            document.getElementById('battleScreen').classList.add('show');

            // „É¢„É≥„Çπ„Çø„ÉºÈÅ∏ÊäûÔºà„É¨„Éô„É´„Å´Âøú„Åò„Å¶Ôºâ
            let monsterType;
            const rand = Math.random();
            if (player.level >= 5 && rand < 0.3) {
                monsterType = 'dragon';
            } else if (player.level >= 3 && rand < 0.5) {
                monsterType = 'skeleton';
            } else if (player.level >= 2 && rand < 0.6) {
                monsterType = 'ghost';
            } else {
                monsterType = 'slime';
            }

            currentEnemy = { ...monsters[monsterType] };
            currentEnemy.maxHp = currentEnemy.hp;

            document.getElementById('enemySprite').textContent = currentEnemy.sprite;
            document.getElementById('enemyName').textContent = currentEnemy.name;
            document.getElementById('battleMessage').textContent = `${currentEnemy.name}„Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`;

            updateBattleUI();
            showBattleMenu();
        }

        function startBossBattle() {
            gameState = GAME_STATE.BATTLE;
            document.getElementById('battleScreen').classList.add('show');

            currentEnemy = { ...monsters.boss };
            currentEnemy.maxHp = currentEnemy.hp;

            document.getElementById('enemySprite').textContent = currentEnemy.sprite;
            document.getElementById('enemySprite').style.fontSize = '150px';
            document.getElementById('enemyName').textContent = currentEnemy.name;
            document.getElementById('battleMessage').textContent = `È≠îÁéã„Äå„Çà„Åè„Åû„Åì„Åì„Åæ„ÅßÊù•„Åü„ÄÅÂãáËÄÖ„ÇàÔºÅ\n„Å†„Åå„ÄÅ„Åì„Åì„ÅåË≤¥Êßò„ÅÆÂ¢ìÂ†¥„Å®„Å™„ÇãÔºÅ„Äç`;

            updateBattleUI();
            setTimeout(showBattleMenu, 2000);
        }

        function updateBattleUI() {
            document.getElementById('hpText').textContent = player.hp;
            document.getElementById('hpBar').style.width = (player.hp / player.maxHp * 100) + '%';
            document.getElementById('mpText').textContent = player.mp;
            document.getElementById('mpBar').style.width = (player.mp / player.maxMp * 100) + '%';
            document.getElementById('lvText').textContent = player.level;
            document.getElementById('expText').textContent = player.exp;
            document.getElementById('goldText').textContent = player.gold;
        }

        function showBattleMenu() {
            document.getElementById('battleMenu').style.display = 'flex';
            document.getElementById('spellMenu').classList.remove('show');
        }

        function hideBattleMenu() {
            document.getElementById('battleMenu').style.display = 'none';
        }

        // „Éê„Éà„É´„Ç¢„ÇØ„Ç∑„Éß„É≥
        function battleAction(action) {
            if (gameState === GAME_STATE.BATTLE_ANIMATION) return;

            hideBattleMenu();

            switch (action) {
                case 'attack':
                    playerAttack();
                    break;
                case 'spell':
                    document.getElementById('spellMenu').classList.add('show');
                    break;
                case 'item':
                    useItem();
                    break;
                case 'run':
                    tryRun();
                    break;
            }
        }

        function closeSpellMenu() {
            document.getElementById('spellMenu').classList.remove('show');
            showBattleMenu();
        }

        function playerAttack() {
            gameState = GAME_STATE.BATTLE_ANIMATION;
            const damage = Math.max(1, player.attack - currentEnemy.defense + Math.floor(Math.random() * 10) - 5);
            currentEnemy.hp -= damage;

            showDamage(damage, false);
            document.getElementById('battleMessage').textContent = `ÂãáËÄÖ„ÅÆÊîªÊíÉÔºÅ\n${currentEnemy.name}„Å´${damage}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`;

            setTimeout(() => {
                if (currentEnemy.hp <= 0) {
                    enemyDefeated();
                } else {
                    enemyTurn();
                }
            }, 1500);
        }

        function castSpell(spell) {
            document.getElementById('spellMenu').classList.remove('show');
            gameState = GAME_STATE.BATTLE_ANIMATION;

            if (spell === 'hoimi') {
                if (player.mp < 3) {
                    document.getElementById('battleMessage').textContent = 'MP„ÅåË∂≥„Çä„Å™„ÅÑÔºÅ';
                    setTimeout(showBattleMenu, 1000);
                    gameState = GAME_STATE.BATTLE;
                    return;
                }
                player.mp -= 3;
                const heal = 30 + Math.floor(Math.random() * 20);
                player.hp = Math.min(player.maxHp, player.hp + heal);
                showDamage(heal, true);
                document.getElementById('battleMessage').textContent = `„Éõ„Ç§„Éü„ÇíÂî±„Åà„ÅüÔºÅ\nHP„Åå${heal}ÂõûÂæ©„Åó„ÅüÔºÅ`;
                updateBattleUI();
                setTimeout(() => {
                    enemyTurn();
                }, 1500);
            } else if (spell === 'gira') {
                if (player.mp < 4) {
                    document.getElementById('battleMessage').textContent = 'MP„ÅåË∂≥„Çä„Å™„ÅÑÔºÅ';
                    setTimeout(showBattleMenu, 1000);
                    gameState = GAME_STATE.BATTLE;
                    return;
                }
                player.mp -= 4;
                const damage = 20 + Math.floor(Math.random() * 15);
                currentEnemy.hp -= damage;
                showDamage(damage, false);
                document.getElementById('battleMessage').textContent = `„ÇÆ„É©„ÇíÂî±„Åà„ÅüÔºÅ\n${currentEnemy.name}„Å´${damage}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`;
                updateBattleUI();
                setTimeout(() => {
                    if (currentEnemy.hp <= 0) {
                        enemyDefeated();
                    } else {
                        enemyTurn();
                    }
                }, 1500);
            }
        }

        function useItem() {
            gameState = GAME_STATE.BATTLE_ANIMATION;

            if (player.potions <= 0) {
                document.getElementById('battleMessage').textContent = '„ÇÑ„Åè„Åù„ÅÜ„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑÔºÅ';
                setTimeout(() => {
                    gameState = GAME_STATE.BATTLE;
                    showBattleMenu();
                }, 1000);
                return;
            }

            player.potions--;
            const heal = 25 + Math.floor(Math.random() * 10);
            player.hp = Math.min(player.maxHp, player.hp + heal);
            showDamage(heal, true);
            document.getElementById('battleMessage').textContent = `„ÇÑ„Åè„Åù„ÅÜ„Çí‰Ωø„Å£„ÅüÔºÅ\nHP„Åå${heal}ÂõûÂæ©„Åó„ÅüÔºÅ`;
            updateBattleUI();

            setTimeout(() => {
                enemyTurn();
            }, 1500);
        }

        function tryRun() {
            gameState = GAME_STATE.BATTLE_ANIMATION;

            if (currentEnemy.isBoss) {
                document.getElementById('battleMessage').textContent = 'È≠îÁéã„Åã„Çâ„ÅØÈÄÉ„Åí„Çâ„Çå„Å™„ÅÑÔºÅ';
                setTimeout(() => {
                    enemyTurn();
                }, 1500);
                return;
            }

            if (Math.random() < 0.5) {
                document.getElementById('battleMessage').textContent = '„ÅÜ„Åæ„ÅèÈÄÉ„ÅíÂàá„Çå„ÅüÔºÅ';
                setTimeout(endBattle, 1500);
            } else {
                document.getElementById('battleMessage').textContent = 'ÈÄÉ„Åí„Çâ„Çå„Å™„Åã„Å£„ÅüÔºÅ';
                setTimeout(() => {
                    enemyTurn();
                }, 1500);
            }
        }

        function enemyTurn() {
            const damage = Math.max(1, currentEnemy.attack - player.defense + Math.floor(Math.random() * 10) - 5);
            player.hp -= damage;

            document.getElementById('battleMessage').textContent = `${currentEnemy.name}„ÅÆÊîªÊíÉÔºÅ\nÂãáËÄÖ„ÅØ${damage}„ÅÆ„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„ÅüÔºÅ`;
            updateBattleUI();

            setTimeout(() => {
                if (player.hp <= 0) {
                    playerDefeated();
                } else {
                    gameState = GAME_STATE.BATTLE;
                    showBattleMenu();
                }
            }, 1500);
        }

        function enemyDefeated() {
            player.exp += currentEnemy.exp;
            player.gold += currentEnemy.gold;

            if (currentEnemy.isBoss) {
                document.getElementById('battleMessage').textContent = `È≠îÁéã„ÇíÂÄí„Åó„ÅüÔºÅ\n‰∏ñÁïå„Å´Âπ≥Âíå„ÅåÊàª„Å£„ÅüÔºÅ`;
                setTimeout(() => {
                    document.getElementById('battleScreen').classList.remove('show');
                    document.getElementById('gameClear').classList.add('show');
                    gameState = GAME_STATE.CLEAR;
                }, 2000);
                return;
            }

            document.getElementById('battleMessage').textContent =
                `${currentEnemy.name}„ÇíÂÄí„Åó„ÅüÔºÅ\n${currentEnemy.exp}„ÅÆÁµåÈ®ìÂÄ§„Å®${currentEnemy.gold}„Ç¥„Éº„É´„Éâ„ÇíÁç≤ÂæóÔºÅ`;

            // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÉÅ„Çß„ÉÉ„ÇØ
            const expNeeded = player.level * 30;
            if (player.exp >= expNeeded) {
                setTimeout(() => {
                    levelUp();
                }, 1500);
            } else {
                setTimeout(endBattle, 2000);
            }
        }

        function levelUp() {
            player.level++;
            player.exp = 0;
            player.maxHp += 20;
            player.maxMp += 5;
            player.hp = player.maxHp;
            player.mp = player.maxMp;
            player.attack += 5;
            player.defense += 3;

            document.getElementById('battleMessage').textContent =
                `„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ\nÂãáËÄÖ„ÅØ„É¨„Éô„É´${player.level}„Å´„Å™„Å£„ÅüÔºÅ`;
            updateBattleUI();

            setTimeout(endBattle, 2000);
        }

        function playerDefeated() {
            document.getElementById('battleMessage').textContent = 'ÂãáËÄÖ„ÅØÂÄí„Çå„Åü...\nÁõÆ„ÅÆÂâç„ÅåÁúü„Å£Êöó„Å´„Å™„Å£„Åü...';

            setTimeout(() => {
                // Âæ©Ê¥ªÂá¶ÁêÜ
                player.hp = Math.floor(player.maxHp / 2);
                player.mp = Math.floor(player.maxMp / 2);
                player.gold = Math.floor(player.gold / 2);
                player.x = 3;
                player.y = 2;
                endBattle();
                showMessage('ÁéãÊßò„ÅÆÂäõ„ÅßÂæ©Ê¥ª„Åó„Åü...\nÊâÄÊåÅÈáë„ÅåÂçäÂàÜ„Å´„Å™„Å£„Å¶„Åó„Åæ„Å£„Åü„ÄÇ');
            }, 2000);
        }

        function endBattle() {
            document.getElementById('battleScreen').classList.remove('show');
            document.getElementById('enemySprite').style.fontSize = '120px';
            currentEnemy = null;
            gameState = GAME_STATE.FIELD;
        }

        function showDamage(amount, isHeal) {
            const damageEl = document.createElement('div');
            damageEl.className = 'damage-number' + (isHeal ? ' heal' : '');
            damageEl.textContent = (isHeal ? '+' : '-') + amount;
            damageEl.style.left = '50%';
            damageEl.style.top = '30%';
            document.querySelector('.game-container').appendChild(damageEl);

            setTimeout(() => damageEl.remove(), 1000);
        }

        // „Ç≠„ÉºÂÖ•Âäõ
        document.addEventListener('keydown', (e) => {
            if (gameState === GAME_STATE.FIELD) {
                switch (e.key) {
                    case 'ArrowUp': movePlayer(0, -1); break;
                    case 'ArrowDown': movePlayer(0, 1); break;
                    case 'ArrowLeft': movePlayer(-1, 0); break;
                    case 'ArrowRight': movePlayer(1, 0); break;
                }
                draw();
            } else if (gameState === GAME_STATE.MESSAGE) {
                if (e.key === ' ' || e.key === 'Enter') {
                    closeMessage();
                }
            } else if (gameState === GAME_STATE.TITLE) {
                if (e.key === ' ' || e.key === 'Enter') {
                    startGame();
                }
            }
        });

        // „Ç≤„Éº„É†„É´„Éº„Éó
        function gameLoop() {
            draw();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>
